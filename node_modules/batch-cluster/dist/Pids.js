"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.kill = exports.pids = exports.pidExists = void 0;
const child_process_1 = __importDefault(require("child_process"));
const process_1 = __importDefault(require("process"));
const Object_1 = require("./Object");
const Platform_1 = require("./Platform");
function safePid(pid) {
    if (typeof pid !== "number" || pid < 0) {
        throw new Error("invalid pid: " + JSON.stringify(pid));
    }
    else {
        return Math.floor(pid).toString();
    }
}
/*

Windows 10:

>tasklist /NH /FO "CSV" /FI "PID eq 15524"
INFO: No tasks are running which match the specified criteria.

>tasklist /NH /FO "CSV" /FI "PID eq 11968"
"bash.exe","11968","Console","1","5,340 K"

Linux:

$ ps -p 20242
  PID TTY          TIME CMD
20242 pts/3    00:00:00 bash

Mac:

$ ps -p 32183
  PID TTY           TIME CMD
32183 ttys001    0:00.10 /bin/bash -l

*/
/**
 * @param {number} pid process id. Required.
 * @returns {Promise<boolean>} true if the given process id is in the local
 * process table. The PID may be paused or a zombie, though.
 */
function pidExists(pid) {
    if (pid == null)
        return Promise.resolve(false);
    const needle = safePid(pid);
    const cmd = Platform_1.isWin ? "tasklist" : "ps";
    const args = Platform_1.isWin
        ? // NoHeader, FOrmat CSV, FIlter on pid:
            [
                ["/NH", "/FO", "CSV", "/FI", "PID eq " + needle],
                {
                    windowsHide: true,
                },
            ]
        : // linux has "quick" mode (-q) but mac doesn't. We add the ",1" to avoid ps
            // returning exit code 1, which generates an extraneous Error.
            [["-p", needle + ",1"]];
    return new Promise((resolve) => {
        child_process_1.default.execFile(cmd, ...args, (error, stdout) => {
            const result = error == null &&
                new RegExp(Platform_1.isWin ? '"' + needle + '"' : "^\\s*" + needle + "\\b", 
                // The posix regex pattern needs multiline support:
                "m").exec(String(stdout).trim()) != null;
            resolve(result);
        });
    });
}
exports.pidExists = pidExists;
const winRe = /^".+?","(\d+)"/;
const posixRe = /^\s*(\d+)/;
/**
 * @export
 * @returns {Promise<number[]>} all the Process IDs in the process table.
 */
function pids() {
    return new Promise((resolve, reject) => {
        child_process_1.default.execFile(Platform_1.isWin ? "tasklist" : "ps", 
        // NoHeader, FOrmat CSV
        Platform_1.isWin ? ["/NH", "/FO", "CSV"] : ["-e"], (error, stdout, stderr) => {
            if (error != null) {
                reject(error);
            }
            else if (("" + stderr).trim().length > 0) {
                reject(new Error(stderr));
            }
            else
                resolve(("" + stdout)
                    .trim()
                    .split(/[\n\r]+/)
                    .map((ea) => ea.match(Platform_1.isWin ? winRe : posixRe))
                    .map((m) => (0, Object_1.map)(m === null || m === void 0 ? void 0 : m[0], parseInt))
                    .filter((ea) => ea != null));
        });
    });
}
exports.pids = pids;
/**
 * Send a signal to the given process id.
 *
 * @export
 * @param {number} pid the process id. Required.
 * @param {boolean} [force=false] if true, and the current user has
 * permissions to send the signal, the pid will be forced to shut down.
 */
function kill(pid, force = false) {
    if (pid == null)
        return;
    if (pid === process_1.default.pid || pid === process_1.default.ppid) {
        throw new Error("cannot self-terminate");
    }
    if (Platform_1.isWin) {
        const args = ["/PID", safePid(pid), "/T"];
        if (force) {
            args.push("/F");
        }
        child_process_1.default.execFile("taskkill", args);
    }
    else {
        try {
            process_1.default.kill(pid, force ? "SIGKILL" : "SIGTERM");
        }
        catch (err) {
            if (!String(err).includes("ESRCH"))
                throw err;
        }
    }
}
exports.kill = kill;
//# sourceMappingURL=Pids.js.map